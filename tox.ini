[tox]
envlist = lint, test, policy, audit, security
isolated_build = true

[testenv]
deps =
    -e .
commands =
    python -c "print('Tox environment ready')"

[testenv:lint]
deps =
    black>=21.7b0
    isort>=5.9.3
    ruff>=0.1.6
    mypy>=0.910
commands =
    black --check .
    isort --check-only .
    ruff check .
    mypy core_modules/

[testenv:test]
deps =
    pytest>=7.0.0
    pytest-cov>=2.12.1
    pytest-socket>=0.6.0
    -e .
commands =
    pytest tests/ -v --cov=core_modules --cov-report=xml --cov-report=html --cov-report=term-missing

[testenv:policy]
deps =
    -e .
commands =
    python -m core_modules.network.policy --verify
    python -m core_modules.network.policy --print

[testenv:audit]
deps =
    pip-audit>=2.7.3
    safety>=3.2.4
    cyclonedx-bom>=4.3.5
commands =
    pip-audit --requirement requirements.txt
    safety check --full-report -r requirements.txt
    cyclonedx-py requirements -r requirements.txt -o sbom.xml

[testenv:security]
deps =
    bandit>=1.7.5
    -e .
commands =
    bandit -r . -c bandit.yaml -f json -o bandit-report.json
    bandit -r . -c bandit.yaml -f txt

[testenv:clean]
deps =
commands =
    python -c "import os, shutil; dirs=['.pytest_cache','__pycache__','.coverage','htmlcov','.mypy_cache','dist','build']; [ (shutil.rmtree(d, ignore_errors=True), print(f'Cleaned {d}')) for d in dirs if os.path.exists(d) ]"

[testenv:install-dev]
deps =
    -e .
    -r requirements.txt
commands =
    python -c "print('Development dependencies installed')"

[testenv:check-versions]
deps =
    -e .
commands =
    python tools/verify_versions.py

[testenv:format]
deps =
    black>=21.7b0
    isort>=5.9.3
commands =
    black .
    isort .

[testenv:docs]
deps =
    -e .
commands =
    python -c "import os; [print(f'Document: {os.path.join(r, f)}') for r,_,fs in os.walk('docs') for f in fs if f.endswith('.md')]"
