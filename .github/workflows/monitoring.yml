name: Production Monitoring

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of check to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - health
          - security
          - performance

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'health' || github.event.inputs.check_type == ''
    steps:
      - name: Check Production Health
        run: |
          echo "üè• Checking production health..."
          # Add actual health check URLs when deployed
          # curl -f https://echoes.example.com/health || exit 1
          echo "‚úÖ Health check passed"

  security-monitor:
    name: Security Monitoring
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'security' || github.event.inputs.check_type == ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Security Tools
        run: |
          pip install safety bandit pip-audit

      - name: Run Security Audit
        run: |
          echo "üîí Running security audit..."
          safety check --json --output safety-report.json || true
          bandit -r . -f json -o bandit-report.json || true
          pip-audit --format=json --output=pip-audit-report.json || true

      - name: Check for Critical Issues
        run: |
          if [ -f safety-report.json ]; then
            critical=$(cat safety-report.json | jq '.vulnerabilities[] | select(.vulnerability.severity == "CRITICAL") | .vulnerability.id' | wc -l)
            if [ "$critical" -gt 0 ]; then
              echo "‚ùå CRITICAL vulnerabilities found: $critical"
              exit 1
            fi
          fi
          echo "‚úÖ Security monitoring passed"

  performance-monitor:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'performance' || github.event.inputs.check_type == ''
    steps:
      - name: Check Performance Metrics
        run: |
          echo "üìä Checking performance metrics..."
          # Add actual performance checks when deployed
          # curl -f https://echoes.example.com/metrics || exit 1
          echo "‚úÖ Performance check passed"

  notify-alerts:
    name: Send Alerts
    runs-on: ubuntu-latest
    needs: [health-check, security-monitor, performance-monitor]
    if: failure()
    steps:
      - name: Send Alert
        run: |
          echo "üö® ALERT: Production monitoring failed!"
          echo "Check the job logs for details"
          # Add actual alerting (Slack, email, etc.) when needed
          exit 1
