name: build-and-test

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  windows-csharp:
    runs-on: windows-latest
    env:
      SKIP_HTTP_PROBE: 1
      ALLOW_FAKE_JAVA: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Build C# project
        working-directory: csharp
        run: dotnet build language-bundle.csproj --configuration Release

      - name: Validate runner exit codes with/without Java
        shell: pwsh
        working-directory: csharp
        run: |
          if (Test-Path bin) { Remove-Item -Recurse -Force bin }
          dotnet run --project language-bundle.csproj --configuration Release
          if ($LASTEXITCODE -ne 2) { Write-Host "Expected exit code 2 when no java present"; exit 1 }
          New-Item -ItemType Directory -Force -Path bin | Out-Null
          $exe = 'bin\java.exe'
          "@echo off`necho fake java" | Out-File -FilePath $exe -Encoding ascii -Force
          icacls $exe /grant Everyone:F | Out-Null
          dotnet run --project language-bundle.csproj --configuration Release
          if ($LASTEXITCODE -eq 2) { Write-Host "Expected java present -> not exit 2"; exit 1 }

  python-format-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install formatters
        run: |
          python -m pip install --upgrade pip
          pip install black isort autoflake

      - name: Run format_all and fail on diff
        run: |
          python tools/format_all.py --max-len 120
          if ! git diff --quiet; then
            echo "::error::Formatting changes required. Run tools/format_all.py locally."
            git --no-pager diff --minimal --stat
            exit 1
          fi

  python-tests:
    runs-on: ubuntu-latest
    environment:
      name: ECHOES
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[test]

      - name: Run diarisation unit tests
        run: pytest -q tests/test_diarisation.py -m unit

      - name: Run diarisation integration test (optional)
        if: ${{ env.RUN_DIARISATION_INTEGRATION == '1' }}
        env:
          RUN_DIARISATION_INTEGRATION: ${{ env.RUN_DIARISATION_INTEGRATION }}
          HUGGINGFACE_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
          DIARIZATION_AUTH_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
          GITHUB_PAT: ${{ secrets.PAT_ECHOES }}
        run: pytest -q tests/test_diarisation_integration.py -m integration
