name: CI (Python 3.14, no network)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  tests:
    name: Run unit tests (skip network/integration)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.14
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Set up pip cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-security.txt

      - name: Verify security tooling versions
        run: |
          python tools/verify_versions.py

      - name: Run policy verification
        run: |
          python -m core_modules.network.policy --verify --summary-out egress-summary.json

      - name: Upload egress summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: egress-summary
          path: egress-summary.json

      - name: Check for blocked egress
        if: always()
        run: |
          if [ -f egress-summary.json ]; then
            BLOCKED=$(python -c "import json; print(json.load(open('egress-summary.json'))['metrics']['blocked_total'])")
            if [ "$BLOCKED" -gt 0 ]; then
              echo "::warning::Found $BLOCKED blocked egress events"
              # Emit warnings for each unique blocked host
              python -c "
import json
data = json.load(open('egress-summary.json'))
blocked_hosts = set()
for event in data['recent_events']:
    if event['action'] == 'DENY':
        blocked_hosts.add(event['host'])
for host in sorted(blocked_hosts):
    print(f'::warning::Blocked egress to {host}')
"
            fi
          fi

      - name: Run pre-commit (lint/format checks)
        run: |
          python -m pip install pre-commit
          pre-commit run --all-files --show-diff-on-failure || true

      - name: Run pytest (sanitized config)
        run: |
          pytest -c root_configs/pytest.ini -q --cov=core_modules --cov-report=xml --cov-report=html

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: Run security scan
        run: |
          pip-audit --requirement requirements.txt --format sarif -o pip-audit-results.sarif
          safety check --full-report -r requirements.txt > safety-report.txt || true
          bandit -r . -f json -o bandit-report.json || true

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            pip-audit-results.sarif
            safety-report.txt
            bandit-report.json

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: pip-audit-results.sarif

      - name: Generate SBOM
        run: |
          mkdir -p sbom
          cyclonedx-py requirements -r requirements.txt -o sbom/cyclonedx-sbom.xml

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom/cyclonedx-sbom.xml
