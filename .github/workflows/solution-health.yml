name: Solution Health Dashboard

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]
    paths:
      - '**.sln'
      - '**.csproj'
      - '.github/workflows/**'

jobs:
  health-check:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Collect Solution Metrics
      id: metrics
      run: |
        # Solution size metrics
        $solutionSize = (Get-Item *.sln).Length
        "solution_size=$solutionSize" >> $env:GITHUB_OUTPUT

        # Project count
        $projectCount = (Get-Content *.sln | Select-String -Pattern 'Project\(' | Measure-Object).Count
        "project_count=$projectCount" >> $env:GITHUB_OUTPUT

        # Reference count
        $referenceCount = (Get-Content *.sln | Select-String -Pattern '\.Build\.0' | Measure-Object).Count
        "reference_count=$referenceCount" >> $env:GITHUB_OUTPUT

        # Configuration count
        $configCount = (Get-Content *.sln | Select-String -Pattern '\|Any CPU' | Measure-Object).Count
        "config_count=$configCount" >> $env:GITHUB_OUTPUT

    - name: Validate Build Times
      id: build_times
      run: |
        $configs = @('Debug', 'Development', 'Staging', 'Release')
        $totalTime = 0
        $builds = @{}

        foreach ($config in $configs) {
            $start = Get-Date
            dotnet build -c $config
            $duration = ((Get-Date) - $start).TotalSeconds
            $builds[$config] = $duration
            $totalTime += $duration
        }

        "total_build_time=$totalTime" >> $env:GITHUB_OUTPUT
        $builds | ConvertTo-Json > build_times.json

    - name: Generate Health Report
      run: |
        $metrics = @{
          SolutionSize = ${{ steps.metrics.outputs.solution_size }}
          ProjectCount = ${{ steps.metrics.outputs.project_count }}
          ReferenceCount = ${{ steps.metrics.outputs.reference_count }}
          ConfigCount = ${{ steps.metrics.outputs.config_count }}
          TotalBuildTime = ${{ steps.build_times.outputs.total_build_time }}
        }

        $report = @"
        # Solution Health Report
        Generated: $(Get-Date)

        ## Metrics
        - Solution Size: $($metrics.SolutionSize) bytes
        - Projects: $($metrics.ProjectCount)
        - References: $($metrics.ReferenceCount)
        - Configurations: $($metrics.ConfigCount)
        - Total Build Time: $($metrics.TotalBuildTime) seconds

        ## Build Times
        $(Get-Content build_times.json | ConvertFrom-Json | Format-Table | Out-String)
        "@

        $report | Out-File -FilePath health_report.md

    - name: Upload Health Report
      uses: actions/upload-artifact@v3
      with:
        name: solution-health-report
        path: health_report.md
