name: Monthly Review Reminder

on:
  schedule:
    - cron: '0 9 1 * *'
  workflow_dispatch:

jobs:
  remind:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Set date
        id: set_date
        uses: actions/github-script@v6
        with:
          script: |
            const d = new Date();
            const month = d.toLocaleString('default', { month: 'long' });
            const year = d.getFullYear();
            core.setOutput('month', month);
            core.setOutput('year', String(year));

      - name: Create Issue
        id: create_issue
        uses: peter-evans/create-issue@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: Monthly Architecture Review - ${{ steps.set_date.outputs.month }} ${{ steps.set_date.outputs.year }}
          labels: architecture-review,high-priority
          body: |
            # Monthly Architecture Review - ${{ steps.set_date.outputs.month }} ${{ steps.set_date.outputs.year }}

            ## Schedule
            - Date: TBD
            - Time: TBD
            - Location: TBD

            ## Pre-review Tasks
            - [ ] Generate solution health report
            - [ ] Review last month's action items
            - [ ] Gather team feedback
            - [ ] Update metrics dashboard

            ## Agenda
            1. Review previous action items
            2. Solution health metrics review
            3. Technical debt assessment
            4. Architecture decisions discussion
            5. Next steps planning

            ## Required Attendees
            - Architecture team
            - Tech leads
            - Senior developers

            ## Preparation
            Please review:
            - Latest solution health report
            - Outstanding technical debt items
            - Proposed architecture changes
            - Team feedback and pain points

            ## Resources
            - [Solution Health Dashboard](../../actions)
            - [Best Practices Guide](../docs/solution_analysis/best_practices.md)
            - [Previous Review Notes](../docs/solution_analysis/reviews)

            @${{ github.repository_owner }} please schedule the meeting and update this issue.

      - name: Send Teams Notification
        if: ${{ success() }}
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          ISSUE_NUMBER: ${{ steps.create_issue.outputs.issue-number }}
          MONTH: ${{ steps.set_date.outputs.month }}
          YEAR: ${{ steps.set_date.outputs.year }}
        run: |
          if [ -n "$TEAMS_WEBHOOK_URL" ]; then
            curl -H "Content-Type: application/json" -d "{
              \"title\": \"Monthly Architecture Review\",
              \"text\": \"Time to schedule the monthly architecture review for ${MONTH} ${YEAR}! Please check issue #${ISSUE_NUMBER}.\",
              \"themeColor\": \"0076D7\"
            }" "$TEAMS_WEBHOOK_URL"
          fi
